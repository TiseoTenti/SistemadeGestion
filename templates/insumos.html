{% extends "base.html" %}
{% block content %}
<h2>Insumos</h2>

<div class="card mb-3">
  <div class="card-body">
    <form id="formInsumo">
      <div class="row g-2">
        <div class="col-md-3"><input class="form-control" name="nombre" placeholder="Nombre" required></div>
        <div class="col-md-2"><input class="form-control" name="cantidad" type="number" step="0.01" placeholder="Cantidad" required></div>
        <div class="col-md-2"><select class="form-select" name="unidad_medida" required><option value="">Selecc. unidad</option><option value="litro">Litro</option><option value="metro">Metro</option><option value="kilo">Kilo</option><option value="unidad">Unidad</option></select></div>
        <div class="col-md-2"><input class="form-control" name="stock_minimo" type="number" step="0.01" placeholder="Stock mínimo"></div></div>
        <div class="mt-2"><button class="btn btn-primary">Crear Insumo</button></div>
    </form>
  </div>
</div>


<div class="row mb-3">
  <div class="col-md-6 position-relative">
    <input
      type="text"
      id="buscadorInsumo"
      class="form-control"
      placeholder="Buscar insumo por nombre..."
      autocomplete="off"
    >
    <div id="sugerenciasInsumos" class="list-group position-absolute w-100"></div>
  </div>

  <div class="col-md-3">
    <button class="btn btn-primary w-100" onclick="buscarInsumo()">
      Buscar
    </button>
  </div>

  <div class="col-md-3">
    <button class="btn btn-secondary w-100" onclick="cargarInsumos()">
      Ver todos
    </button>
  </div>
</div>





<table class="table table-striped" id="tblInsumos">
  <thead><tr><th>ID</th><th>Nombre</th><th>Cantidad</th><th>Unidad</th><th>Stock Min</th><th>Acciones</th></tr></thead>
  <tbody></tbody>
</table>

<script>
async function cargarInsumos(){
  const res = await fetch('/api/v1/insumos/');
  const data = await res.json();
  const tbody = document.querySelector('#tblInsumos tbody');
  tbody.innerHTML = '';

  data.forEach(i => {
    tbody.innerHTML += `
      <tr id="row-${i.id_insumo}">
        <td>${i.id_insumo}</td>
        <td>${i.nombre}</td>
        <td>${i.cantidad}</td>
        <td>${i.unidad_medida}</td>
        <td>${i.stock_minimo}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="toggleEditar(${i.id_insumo})">Editar</button>
        </td>
      </tr>

      <tr id="edit-${i.id_insumo}" class="d-none bg-light">
        <td colspan="6">
          <div class="row g-2">
            <div class="col-md-3"><input class="form-control" id="nombre-${i.id_insumo}" value="${i.nombre}"></div>
            <div class="col-md-2"><input class="form-control" type="number" step="0.01" id="cantidad-${i.id_insumo}" value="${i.cantidad}"></div>
            <div class="col-md-2">
              <select class="form-select" id="unidad-${i.id_insumo}">
                <option ${i.unidad_medida=='litro'?'selected':''}>litro</option>
                <option ${i.unidad_medida=='metro'?'selected':''}>metro</option>
                <option ${i.unidad_medida=='kilo'?'selected':''}>kilo</option>
                <option ${i.unidad_medida=='unidad'?'selected':''}>unidad</option>
              </select>
            </div>
            <div class="col-md-2"><input class="form-control" type="number" step="0.01" id="stock-${i.id_insumo}" value="${i.stock_minimo}"></div>
            <div class="col-md-3">
              <button class="btn btn-success btn-sm" onclick="guardarEdicion(${i.id_insumo})">Guardar</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleEditar(${i.id_insumo})">Cancelar</button>
            </div>
          </div>
        </td>
      </tr>
    `;
  });
} // <-- Cierre correcto de cargarInsumos()

// Funciones auxiliares
function toggleEditar(id) {
  const fila = document.getElementById(`edit-${id}`);
  fila.classList.toggle('d-none');
}

async function guardarEdicion(id) {
  const body = {
    nombre: document.getElementById(`nombre-${id}`).value,
    cantidad: parseFloat(document.getElementById(`cantidad-${id}`).value),
    unidad_medida: document.getElementById(`unidad-${id}`).value,
    stock_minimo: parseFloat(document.getElementById(`stock-${id}`).value)
  };

  const res = await fetch(`/api/v1/insumos/${id}`, {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    alert('Error al actualizar insumo');
    return;
  }

  toggleEditar(id);
  cargarInsumos();
}

// Buscador
const buscadorInsumo = document.getElementById('buscadorInsumo');
const sugerenciasInsumos = document.getElementById('sugerenciasInsumos');

buscadorInsumo.addEventListener('input', async () => {
  const q = buscadorInsumo.value.trim();
  sugerenciasInsumos.innerHTML = '';
  delete buscadorInsumo.dataset.id;

  if (q.length < 2) return;

  const res = await fetch(`/api/v1/insumos/buscar?q=${encodeURIComponent(q)}`);
  const data = await res.json();

  data.forEach(i => {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'list-group-item list-group-item-action';
    item.textContent = i.nombre;

    item.onclick = () => {
      buscadorInsumo.value = i.nombre;
      buscadorInsumo.dataset.id = i.id_insumo;
      sugerenciasInsumos.innerHTML = '';
    };

    sugerenciasInsumos.appendChild(item);
  });
});

// Buscar y editar
async function buscarInsumo() {
  const id = buscadorInsumo.dataset.id;
  if (!id) { alert('Seleccione un insumo de la lista'); return; }

  const res = await fetch(`/api/v1/insumos/${id}`);
  const i = await res.json();

  const tbody = document.querySelector('#tblInsumos tbody');
  tbody.innerHTML = `
    <tr>
      <td>${i.id_insumo}</td>
      <td>${i.nombre}</td>
      <td>${i.cantidad}</td>
      <td>${i.unidad_medida}</td>
      <td>${i.stock_minimo}</td>
      <td><button class="btn btn-sm btn-warning" onclick="editarInsumo(${i.id_insumo})">Editar</button></td>
    </tr>
  `;
}

async function eliminarInsumo(id){
  if(!confirm('¿Eliminar este insumo?')) return;
  await fetch(`/api/v1/insumos/${id}`, { method: 'DELETE' });
  cargarInsumos();
}

async function editarInsumo(id){
  const res = await fetch(`/api/v1/insumos/${id}`);
  const i = await res.json();

  const form = document.getElementById('formInsumo');
  form.nombre.value = i.nombre;
  form.cantidad.value = i.cantidad;
  form.unidad_medida.value = i.unidad_medida;
  form.stock_minimo.value = i.stock_minimo;

  form.dataset.editando = id;
}

// <-- Listener del formulario FUERA de cargarInsumos()
document.getElementById('formInsumo').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const body = Object.fromEntries(fd.entries());

  body.cantidad = parseFloat(body.cantidad || 0);
  body.stock_minimo = parseFloat(body.stock_minimo || 0);

  if(form.dataset.editando){
    // UPDATE
    await fetch(`/api/v1/insumos/${form.dataset.editando}`, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    delete form.dataset.editando;
  } else {
    // CREATE
    await fetch('/api/v1/insumos/', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
  }

  form.reset();
  cargarInsumos();
});

// Cargar tabla al inicio
window.addEventListener('load', cargarInsumos);
</script>
{% endblock %}