{% extends "base.html" %}
{% block content %}

<script>
  const currentUserIsAdmin = JSON.parse('{{ current_user_is_admin | tojson }}');
</script>


<h2>Registrar Salida de Insumos</h2>

<div class="card mb-3">
  <div class="card-body">
    <form id="formSalida">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Tanque Fabricado</label>
          <select class="form-select" name="id_tanque" id="selTanque" required></select>
        </div>
        <div class="col-md-3 position-relative">
           <label class="form-label">Insumo</label>
           <input type="text" class="form-control" id="inpInsumo" placeholder="Buscar insumo..." autocomplete="off" required>
           <div id="sugerenciasInsumos" class="list-group position-absolute w-100" style="z-index:1000;"></div>
           <input type="hidden" name="id_insumo" id="idInsumo">
        </div>


        <div class="col-md-2">
          <label class="form-label">Cantidad usada</label>
          <input class="form-control" type="number" name="cantidad_usada" step="0.01" min="0" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Operario</label>
          <input type="text" class="form-control" name="operario" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
           <button class="btn btn-primary w-100">Registrar Salida</button>
        </div>

      </div>
    </form>
  </div>
</div>




<div class="row mb-3">
  <div class="col-md-6 position-relative">
    <input type="text" class="form-control" id="buscarInsumo"
           placeholder="Buscar por insumo..." autocomplete="off">
    <div id="sugerenciasFiltro"
         class="list-group position-absolute w-100"
         style="z-index:1000;"></div>
    <input type="hidden" id="idInsumoFiltro">
  </div>

  <div class="col-md-6 d-flex gap-2">
    <button class="btn btn-primary" id="btnBuscar">Buscar</button>
    <button class="btn btn-secondary" id="btnVerTodos">Ver todos</button>
  </div>
</div>





<h4>Salidas Registradas</h4>
<table class="table table-striped" id="tblSalidas">
  <thead>
    <tr>
      <th>ID</th>
      <th>Tanque</th>
      <th>Insumo</th>
      <th>Cantidad Usada</th>
      <th>Costo Unitario</th>
      <th>Subtotal</th>
      <th>Operario</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// -----------------------------
// Cargar tanques fabricados
// -----------------------------
async function cargarTanques() {
  const res = await fetch('/api/v1/tanques/activos');  // <- endpoint solo de tanques activos
  const data = await res.json();
  const sel = document.getElementById('selTanque');
  sel.innerHTML = '<option value="">Seleccione un tanque</option>';
  data.forEach(t => {
    sel.innerHTML += `<option value="${t.id_tanque}">${t.modelo || 'Tanque'} (${t.cliente_nombre || 'Cliente'})</option>`;
  });
}



// -----------------------------
// Cargar salidas registradas
// -----------------------------
async function cargarSalidas() {
  const res = await fetch('/api/v1/insumos_salida/');
  const data = await res.json();
  const tbody = document.querySelector('#tblSalidas tbody');
  tbody.innerHTML = '';
  data.forEach(r => {
    tbody.innerHTML += `<tr>
      <td>${r.id_tanque_insumo}</td>
      <td>${r.tanque_nombre}</td>
      <td>${r.insumo_nombre}</td>
      <td>${r.cantidad_usada}</td>
      <td>$${r.costo_unitario.toFixed(2)}</td>
      <td>$${(r.cantidad_usada * r.costo_unitario).toFixed(2)}</td>
      <td>${r.operario || '-'}</td>
      <td>${r.fecha_registro ? new Date(r.fecha_registro).toLocaleString() : '-'}</td>
      
      <td>
        <button class="btn btn-sm btn-warning" onclick="editarSalida(${r.id_tanque_insumo})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminarSalida(${r.id_tanque_insumo})">Eliminar</button>

      </td>

        
    </tr>`;
  });
}


// Cargar todas las salidas
async function cargarSalidas() {
  const res = await fetch('/api/v1/insumos_salida/');
  const data = await res.json();
  mostrarSalidas(data);
}




async function editarSalida(id) {
    if (!currentUserIsAdmin) {
        alert('⚠️ No tiene permisos para editar esta salida');
        return;
    }

    const res = await fetch(`/api/v1/insumos_salida/${id}`);
    if (!res.ok) return alert('No se pudo cargar la salida');

    const r = await res.json();
    const form = document.getElementById('formSalida');
    form.id_tanque.value = r.id_tanque;
    form.id_insumo.value = r.id_insumo;
    form.cantidad_usada.value = r.cantidad_usada;
    form.operario.value = r.operario || '';

    form.dataset.editando = id;
}

async function eliminarSalida(id) {
    if (!currentUserIsAdmin) {
        alert('⚠️ No tiene permisos para eliminar esta salida');
        return;
    }

    if (!confirm('¿Eliminar esta salida y revertir el stock?')) return;

    const res = await fetch(`/api/v1/insumos_salida/${id}`, {
        method: 'DELETE'
    });

    const data = await res.json();

    if (res.ok) {
        alert('✅ Salida eliminada y stock restaurado');
        cargarSalidas();
    } else {
        alert('⚠️ Error: ' + (data.error || 'No se pudo eliminar'));
    }
}








//Buscar insumos
const buscarInsumo = document.getElementById('buscarInsumo');
const sugerenciasFiltro = document.getElementById('sugerenciasFiltro');
const idInsumoFiltro = document.getElementById('idInsumoFiltro');
const btnVerTodos = document.getElementById('btnVerTodos');

// Función para mostrar salidas en la tabla
async function mostrarSalidas(salidas) {
  const tbody = document.querySelector('#tblSalidas tbody');
  tbody.innerHTML = '';

  // Ordenar de mayor a menor por ID
  salidas.sort((a, b) => b.id_tanque_insumo - a.id_tanque_insumo);

  salidas.forEach(r => {
    tbody.innerHTML += `<tr>
      <td>${r.id_tanque_insumo}</td>
      <td>${r.tanque_nombre}</td>
      <td>${r.insumo_nombre}</td>
      <td>${r.cantidad_usada}</td>
      <td>$${r.costo_unitario.toFixed(2)}</td>
      <td>$${(r.cantidad_usada * r.costo_unitario).toFixed(2)}</td>
      <td>${r.operario || '-'}</td>
      <td>${r.fecha_registro ? new Date(r.fecha_registro).toLocaleString() : '-'}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="editarSalida(${r.id_tanque_insumo})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminarSalida(${r.id_tanque_insumo})">Eliminar</button>
      </td>
    </tr>`;
  });
}



// ------------------------
// Autocompletado y filtro
// ------------------------
buscarInsumo.addEventListener('input', async () => {
  const q = buscarInsumo.value.trim();
  sugerenciasFiltro.innerHTML = '';
  idInsumoFiltro.value = '';

  if (q.length < 2) return;

  const res = await fetch(`/api/v1/insumos/buscar?q=${encodeURIComponent(q)}`);
  if (!res.ok) return;

  const insumos = await res.json();

  insumos.forEach(i => {
  const item = document.createElement('button');
  item.type = 'button';
  item.className = 'list-group-item list-group-item-action';
  item.textContent = `${i.nombre} (Stock: ${i.cantidad || 0})`;


  item.onclick = () => {
    inpInsumo.value = i.nombre;
    idInsumo.value = i.id_insumo;
    sugerenciasInsumos.innerHTML = '';
  };

  sugerenciasInsumos.appendChild(item);
});

});


// Boton buscar
const btnBuscar = document.getElementById('btnBuscar');

btnBuscar.addEventListener('click', async () => {
  const idInsumo = idInsumoFiltro.value;

  if (!idInsumo) {
    alert('Seleccione un insumo de la lista');
    return;
  }

  const res = await fetch(`/api/v1/insumos_salida/?id_insumo=${idInsumo}`);
  if (!res.ok) {
    alert('Error al buscar salidas');
    return;
  }

  const data = await res.json();
  mostrarSalidas(data);
});



// Botón "Ver todos"
btnVerTodos.addEventListener('click', () => {
  buscarInsumo.value = '';
  idInsumoFiltro.value = '';
  sugerenciasFiltro.innerHTML = '';
  cargarSalidas();
});







// Autocompletado para registrar salida
inpInsumo.addEventListener('input', async () => {
  const q = inpInsumo.value.trim();
  sugerenciasInsumos.innerHTML = '';
  idInsumo.value = '';

  if (!q) return;


  const res = await fetch(`/api/v1/insumos/buscar?q=${encodeURIComponent(q)}`);
  if (!res.ok) return;

  const insumos = await res.json();

  insumos.forEach(i => {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'list-group-item list-group-item-action';
    item.textContent = `${i.nombre} (Stock: ${i.stock})`;

    item.onclick = () => {
      inpInsumo.value = i.nombre;
      idInsumo.value = i.id_insumo;
      sugerenciasInsumos.innerHTML = '';
    };

    sugerenciasInsumos.appendChild(item);
  });
});


// Cerrar sugerencias si clic fuera del input
document.addEventListener('click', e => {
  if (!inpInsumo.contains(e.target) && !sugerenciasInsumos.contains(e.target)) {
    sugerenciasInsumos.innerHTML = '';
  }
});


document.addEventListener('click', e => {
  if (!buscarInsumo.contains(e.target) && !sugerenciasFiltro.contains(e.target)) {
    sugerenciasFiltro.innerHTML = '';
  }
});






// -----------------------------
// Registrar salida (POST)
// -----------------------------
document.getElementById('formSalida').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const body = Object.fromEntries(fd.entries());
  body.id_insumo = parseInt(idInsumo.value || 0); // usar id real
  body.cantidad_usada = parseFloat(body.cantidad_usada || 0);

  if (form.dataset.editando) {
    // UPDATE: modificar salida existente
    const res = await fetch(`/api/v1/insumos_salida/${form.dataset.editando}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (res.ok) {
      alert('✅ Salida actualizada correctamente');
    } else {
      alert('⚠️ Error: ' + (data.error || 'No se pudo actualizar'));
    }

    delete form.dataset.editando; // limpiar modo edición
  } else {
    // CREATE: registrar nueva salida
    const res = await fetch('/api/v1/insumos_salida/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (res.ok) {
      alert('✅ Salida registrada correctamente');
    } else {
      alert('⚠️ Error: ' + (data.error || 'No se pudo registrar'));
    }
  }

  form.reset();
 
  cargarSalidas();
});


// Inicializar
window.addEventListener('load', () => {
  cargarTanques();
  cargarSalidas();
});
</script>
{% endblock %}

